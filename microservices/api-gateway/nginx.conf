events {}

http {
  # Map to handle CORS
  map $request_method $cors_method {
    OPTIONS 11;
    default 0;
  }

  server {
    listen 80;

    location /api/identity {
      # CORS headers
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
      add_header 'Access-Control-Max-Age' '3600' always;

      if ($request_method = 'OPTIONS') {
        return 204;
      }

      proxy_pass http://identity-service:3001;
      rewrite ^/api/identity/(.*) /$1 break;
    }

    location /api/catalog {
      # CORS headers
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
      add_header 'Access-Control-Max-Age' '3600' always;

      if ($request_method = 'OPTIONS') {
        return 204;
      }

      proxy_pass http://catalog-service:3002;
      rewrite ^/api/catalog/(.*) /$1 break;
    }

    location /api/orders {
      # CORS headers
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
      add_header 'Access-Control-Max-Age' '3600' always;

      if ($request_method = 'OPTIONS') {
        return 204;
      }

      proxy_pass http://order-service:3003;
      rewrite ^/api/orders/(.*) /$1 break;
      rewrite ^/api/orders$ / break;  # Handle request without trailing slash
    }

    location /api/bot {
      # CORS headers
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
      add_header 'Access-Control-Max-Age' '3600' always;

      if ($request_method = 'OPTIONS') {
        return 204;
      }

      proxy_pass http://ayurbot-service:8000;
      rewrite ^/api/bot/(.*) /$1 break;
    }

    location /api/translate {
      # CORS headers
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept' always;
      add_header 'Access-Control-Max-Age' '3600' always;

      if ($request_method = 'OPTIONS') {
        return 204;
      }

      # Route to catalog-service which handles Redis caching
      proxy_pass http://catalog-service:3002/translate;
    }

    location / {
      proxy_pass http://frontend:3000;
    }
  }
}
